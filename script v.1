
DROP USER marzan CASCADE;


CREATE USER marzan IDENTIFIED BY marzan
DEFAULT TABLESPACE users
TEMPORARY TABLESPACE temp
QUOTA UNLIMITED ON users;

GRANT CONNECT, RESOURCE, DBA TO marzan;

CONNECT marzan/marzan;









--------------------------------------------------
-- PARTS CATEGORY
--------------------------------------------------

CREATE TABLE parts_category (
parts_cat_id    VARCHAR2(50) PRIMARY KEY,
parts_cat_code  VARCHAR2(50),
parts_cat_name  VARCHAR2(200),
status          NUMBER,
cre_by          VARCHAR2(100),
cre_dt          DATE,
upd_by          VARCHAR2(100),
upd_dt          DATE,
CONSTRAINT uq_parts_cat_name UNIQUE (parts_cat_name)
);

CREATE SEQUENCE parts_cat_seq START WITH 1 INCREMENT BY 5 NOCACHE NOCYCLE;

CREATE OR REPLACE TRIGGER trg_parts_category_bi
BEFORE INSERT OR UPDATE ON parts_category
FOR EACH ROW
DECLARE v_seq NUMBER; v_code VARCHAR2(100);
BEGIN
IF INSERTING THEN
v_seq := parts_cat_seq.NEXTVAL;
IF :NEW.parts_cat_code IS NOT NULL THEN
v_code := UPPER(TRIM(:NEW.parts_cat_code));
:NEW.parts_cat_id := v_code || TO_CHAR(v_seq);
ELSE
:NEW.parts_cat_id := TO_CHAR(v_seq);
END IF;
IF :NEW.status IS NULL THEN :NEW.status := 1; END IF;
IF :NEW.cre_by IS NULL THEN :NEW.cre_by := NVL(V('APP_USER'), USER); END IF;
IF :NEW.cre_dt IS NULL THEN :NEW.cre_dt := SYSDATE; END IF;
ELSIF UPDATING THEN
IF :NEW.upd_by IS NULL THEN :NEW.upd_by := NVL(V('APP_USER'), USER); END IF;
IF :NEW.upd_dt IS NULL THEN :NEW.upd_dt := SYSDATE; END IF;
END IF;
END;
/

--------------------------------------------------
-- PARTS
--------------------------------------------------
CREATE TABLE parts (
parts_id       VARCHAR2(50) PRIMARY KEY,
parts_code     VARCHAR2(50),
parts_name     VARCHAR2(200),
price          NUMBER(15,2),
parts_cat_id   VARCHAR2(50),
status         NUMBER,
cre_by         VARCHAR2(100),
cre_dt         DATE,
upd_by         VARCHAR2(100),
upd_dt         DATE,
CONSTRAINT fk_parts_parts_cat FOREIGN KEY (parts_cat_id)
REFERENCES parts_category(parts_cat_id)
);

CREATE SEQUENCE parts_seq START WITH 1 INCREMENT BY 5 NOCACHE NOCYCLE;

CREATE OR REPLACE TRIGGER trg_parts_bi
BEFORE INSERT OR UPDATE ON parts
FOR EACH ROW
DECLARE v_seq NUMBER; v_code VARCHAR2(100);
BEGIN
IF INSERTING THEN
v_seq := parts_seq.NEXTVAL;
IF :NEW.parts_code IS NOT NULL THEN
v_code := UPPER(TRIM(:NEW.parts_code));
:NEW.parts_id := v_code || TO_CHAR(v_seq);
ELSE
:NEW.parts_id := TO_CHAR(v_seq);
END IF;
IF :NEW.status IS NULL THEN :NEW.status := 1; END IF;
IF :NEW.cre_by IS NULL THEN :NEW.cre_by := NVL(V('APP_USER'), USER); END IF;
IF :NEW.cre_dt IS NULL THEN :NEW.cre_dt := SYSDATE; END IF;
ELSIF UPDATING THEN
IF :NEW.upd_by IS NULL THEN :NEW.upd_by := NVL(V('APP_USER'), USER); END IF;
IF :NEW.upd_dt IS NULL THEN :NEW.upd_dt := SYSDATE; END IF;
END IF;
END;
/
--------------------------------------------------
-- CUSTOMERS (FIXED SYNTAX)
--------------------------------------------------
CREATE TABLE customers (
    customer_id     VARCHAR2(50) PRIMARY KEY,
    customer_name   VARCHAR2(200) NOT NULL,
    phone_no        VARCHAR2(50) NOT NULL,
    alternative_phone_no VARCHAR2(50),
    address         VARCHAR2(300),
    city            VARCHAR2(100),
    rewards_points  NUMBER,
    notes           VARCHAR2(500),
    status          NUMBER,
    cre_dt          DATE,
    cre_by          VARCHAR2(50),
    upd_by          VARCHAR2(50),
    upd_dt          DATE,
    CONSTRAINT uq_customers_phone UNIQUE (phone_no)
);

CREATE OR REPLACE TRIGGER trg_customers_bi
BEFORE INSERT OR UPDATE ON customers
FOR EACH ROW
DECLARE
  v_code VARCHAR2(100);
BEGIN
 IF INSERTING THEN

  IF :NEW.phone_no IS NOT NULL THEN
   v_code := UPPER(TRIM(:NEW.phone_no));
   :NEW.customer_id := v_code;
  ELSE
   RAISE_APPLICATION_ERROR(
     -20001,
     'Phone number is required for customer ID'
   );
  END IF;

  IF :NEW.status IS NULL THEN
    :NEW.status := 1;
  END IF;

  IF :NEW.cre_by IS NULL THEN
    :NEW.cre_by := NVL(V('APP_USER'), USER);
  END IF;

  IF :NEW.cre_dt IS NULL THEN
    :NEW.cre_dt := SYSDATE;
  END IF;

 ELSE

  -- Optional: prevent phone number change
  IF :NEW.phone_no <> :OLD.phone_no THEN
    RAISE_APPLICATION_ERROR(
      -20002,
      'Phone number cannot be changed'
    );
  END IF;

  IF :NEW.upd_by IS NULL THEN
    :NEW.upd_by := NVL(V('APP_USER'), USER);
  END IF;

  IF :NEW.upd_dt IS NULL THEN
    :NEW.upd_dt := SYSDATE;
  END IF;

 END IF;
END;
/



--------------------------------------------------
-- COMPANY
--------------------------------------------------
CREATE TABLE company (
    company_id          varchar2(50) PRIMARY KEY,
    company_name        VARCHAR2(200) NOT NULL UNIQUE,
    company_proprietor  VARCHAR2(200),
    phone_no            VARCHAR2(50) NOT NULL UNIQUE,
    email               VARCHAR2(200) NOT NULL UNIQUE,
    address             VARCHAR2(300),
    website             VARCHAR2(200) UNIQUE,
    contact_person      VARCHAR2(200),
    cp_designation      VARCHAR2(200),
    cp_phone_no         VARCHAR2(50),
    tag_line            VARCHAR2(300),
    mission_vision      VARCHAR2(1000),
    status              VARCHAR2(50),
    cre_by              VARCHAR2(100),
    cre_dt              DATE,
    upd_by              VARCHAR2(100),
    upd_dt              DATE
);

CREATE SEQUENCE company_seq START WITH 1 INCREMENT BY 5 NOCACHE NOCYCLE;

CREATE OR REPLACE TRIGGER trg_company_bi
BEFORE INSERT OR UPDATE ON company
FOR EACH ROW
DECLARE v_seq NUMBER; v_code VARCHAR2(100);
BEGIN
 IF INSERTING THEN
  v_seq := company_seq.NEXTVAL;
  IF :NEW.company_name IS NOT NULL THEN
   v_code := UPPER(SUBSTR(TRIM(:NEW.company_name),1,3));
   :NEW.company_id := v_code || TO_CHAR(v_seq);
  ELSE
   :NEW.company_id := TO_CHAR(v_seq);
  END IF;
  IF :NEW.status IS NULL THEN :NEW.status := 1; END IF;
  IF :NEW.cre_by IS NULL THEN :NEW.cre_by := NVL(V('APP_USER'), USER); END IF;
  IF :NEW.cre_dt IS NULL THEN :NEW.cre_dt := SYSDATE; END IF;
 ELSE
  IF :NEW.upd_by IS NULL THEN :NEW.upd_by := NVL(V('APP_USER'), USER); END IF;
  IF :NEW.upd_dt IS NULL THEN :NEW.upd_dt := SYSDATE; END IF;
 END IF;
END;
/

--------------------------------------------------
CREATE TABLE departments (
    department_id varchar2(50) PRIMARY KEY,
    department_name VARCHAR2(50),
    manager_id varchar2(50),
    company_id varchar2(50),
    status VARCHAR2(50),
    cre_by VARCHAR2(50),
    cre_dt DATE,
    upd_by VARCHAR2(50),
    upd_dt DATE,
    CONSTRAINT fk_dept_company FOREIGN KEY (company_id)
    REFERENCES company(company_id)
);

CREATE SEQUENCE departments_seq START WITH 1 INCREMENT BY 5 NOCACHE NOCYCLE;

CREATE OR REPLACE TRIGGER trg_departments_bi
BEFORE INSERT OR UPDATE ON departments
FOR EACH ROW
DECLARE v_seq NUMBER; v_code VARCHAR2(100);
BEGIN
 IF INSERTING THEN
  v_seq := departments_seq.NEXTVAL;
  IF :NEW.department_name IS NOT NULL THEN
   v_code := UPPER(SUBSTR(TRIM(:NEW.department_name),1,3));
   :NEW.department_id := v_code || TO_CHAR(v_seq);
  ELSE
   :NEW.department_id := TO_CHAR(v_seq);
  END IF;
  IF :NEW.status IS NULL THEN :NEW.status := 1; END IF;
  IF :NEW.cre_by IS NULL THEN :NEW.cre_by := NVL(V('APP_USER'), USER); END IF;
  IF :NEW.cre_dt IS NULL THEN :NEW.cre_dt := SYSDATE; END IF;
 ELSE
  IF :NEW.upd_by IS NULL THEN :NEW.upd_by := NVL(V('APP_USER'), USER); END IF;
  IF :NEW.upd_dt IS NULL THEN :NEW.upd_dt := SYSDATE; END IF;
 END IF;
END;
/

--------------------------------------------------
-- JOBS
--------------------------------------------------
CREATE TABLE jobs (
    job_id VARCHAR2(30) PRIMARY KEY,
    job_code VARCHAR2(50),
    job_title VARCHAR2(50),
    job_grade VARCHAR2(1),
    min_salary NUMBER,
    max_salary NUMBER,
    status VARCHAR2(50),
    cre_by VARCHAR2(50),
    cre_dt DATE,
    upd_by VARCHAR2(50),
    upd_dt DATE,
    CONSTRAINT chk_job_grade CHECK (job_grade IN ('A','B','C') OR job_grade IS NULL)
);

CREATE SEQUENCE jobs_seq START WITH 1 INCREMENT BY 5 NOCACHE NOCYCLE;

CREATE OR REPLACE TRIGGER trg_jobs
BEFORE INSERT OR UPDATE ON jobs
FOR EACH ROW
DECLARE
    v_seq_val NUMBER;
    v_code    VARCHAR2(50);
BEGIN
    IF INSERTING THEN
        v_seq_val := jobs_seq.NEXTVAL;

        IF :new.job_code IS NOT NULL THEN
            v_code := UPPER(TRIM(:new.job_code));  
            :new.job_id := v_code || TO_CHAR(v_seq_val);  
        ELSE
            :new.job_id := TO_CHAR(v_seq_val);
        END IF;

        IF :new.status IS NULL THEN
            :new.status := 1;
        END IF;
        IF :new.cre_by IS NULL THEN
            :new.cre_by := NVL(V('APP_USER'), USER);
        END IF;
        IF :new.cre_dt IS NULL THEN
            :new.cre_dt := SYSDATE;
        END IF;

    ELSIF UPDATING THEN
        IF :new.upd_by IS NULL THEN
            :new.upd_by := NVL(V('APP_USER'), USER);
        END IF;
        IF :new.upd_dt IS NULL THEN
            :new.upd_dt := SYSDATE;
        END IF;
 
    END IF;
EXCEPTION
    WHEN OTHERS THEN
        RAISE;
END;
/

--------------------------------------------------
-- EMPLOYEES
--------------------------------------------------
CREATE TABLE employees (
    employee_id varchar2(50) PRIMARY KEY,
    first_name VARCHAR2(50),
    last_name VARCHAR2(50) NOT NULL,
    job_id VARCHAR2(30),
    department_id varchar2(50),
    manager_id varchar2(50),
    status VARCHAR2(50),
    cre_by VARCHAR2(50),
    cre_dt DATE,
    upd_by VARCHAR2(50),
    upd_dt DATE
);

ALTER TABLE employees ADD CONSTRAINT fk_emp_job
FOREIGN KEY (job_id) REFERENCES jobs(job_id);

ALTER TABLE employees ADD CONSTRAINT fk_emp_dept
FOREIGN KEY (department_id) REFERENCES departments(department_id);

ALTER TABLE employees ADD CONSTRAINT fk_emp_mgr
FOREIGN KEY (manager_id) REFERENCES employees(employee_id);

CREATE SEQUENCE employees_seq START WITH 1 INCREMENT BY 5 NOCACHE NOCYCLE;

CREATE OR REPLACE TRIGGER trg_employees_bi
BEFORE INSERT OR UPDATE ON employees
FOR EACH ROW
DECLARE v_seq NUMBER; v_code VARCHAR2(100);
BEGIN
 IF INSERTING THEN
  v_seq := employees_seq.NEXTVAL;
  IF :NEW.last_name IS NOT NULL THEN
    v_code := UPPER(SUBSTR(TRIM(:NEW.last_name),1,3));
    :NEW.employee_id := v_code || TO_CHAR(v_seq);
  ELSE
    :NEW.employee_id := TO_CHAR(v_seq);
  END IF;
  IF :NEW.status IS NULL THEN :NEW.status := 1; END IF;
  IF :NEW.cre_by IS NULL THEN :NEW.cre_by := NVL(V('APP_USER'), USER); END IF;
  IF :NEW.cre_dt IS NULL THEN :NEW.cre_dt := SYSDATE; END IF;
 ELSE
  IF :NEW.upd_by IS NULL THEN :NEW.upd_by := NVL(V('APP_USER'), USER); END IF;
  IF :NEW.upd_dt IS NULL THEN :NEW.upd_dt := SYSDATE; END IF;
 END IF;
END;
/

-- FIX CIRCULAR FK (DEFERRABLE)

ALTER TABLE departments
ADD CONSTRAINT fk_dept_mgr
FOREIGN KEY (manager_id)
REFERENCES employees(employee_id)
DEFERRABLE INITIALLY DEFERRED;

--------------------------------------------------
-- USERS
--------------------------------------------------
CREATE TABLE com_users (
    user_id VARCHAR2(50) PRIMARY KEY,
    user_name VARCHAR2(50) UNIQUE NOT NULL,
    password VARCHAR2(100) NOT NULL,
    role VARCHAR2(50) DEFAULT 'user',
    employee_id varchar2(50),
    status VARCHAR2(50),
    cre_by VARCHAR2(50),
    cre_dt DATE,
    upd_by VARCHAR2(50),
    upd_dt DATE
);

ALTER TABLE com_users ADD CONSTRAINT fk_users_emp
FOREIGN KEY (employee_id)
REFERENCES employees(employee_id)
ON DELETE SET NULL;

CREATE SEQUENCE users_seq START WITH 1 INCREMENT BY 5 NOCACHE NOCYCLE;

CREATE OR REPLACE TRIGGER trg_users_bi
BEFORE INSERT OR UPDATE ON com_users
FOR EACH ROW
DECLARE v_seq NUMBER; v_code VARCHAR2(100);
BEGIN
 IF INSERTING THEN
  v_seq := users_seq.NEXTVAL;
  IF :NEW.user_name IS NOT NULL THEN
    v_code := UPPER(SUBSTR(TRIM(:NEW.user_name),1,3));
    :NEW.user_id := v_code || TO_CHAR(v_seq);
  ELSE
    :NEW.user_id := TO_CHAR(v_seq);
  END IF;
  IF :NEW.status IS NULL THEN :NEW.status := 1; END IF;
  IF :NEW.cre_by IS NULL THEN :NEW.cre_by := NVL(V('APP_USER'), USER); END IF;
  IF :NEW.cre_dt IS NULL THEN :NEW.cre_dt := SYSDATE; END IF;
 ELSE
  IF :NEW.upd_by IS NULL THEN :NEW.upd_by := NVL(V('APP_USER'), USER); END IF;
  IF :NEW.upd_dt IS NULL THEN :NEW.upd_dt := SYSDATE; END IF;
 END IF;
END;
/

--------------------------------------------------
-- SERVICE_LIST
--------------------------------------------------

CREATE TABLE service_list (
servicelist_id VARCHAR2(50) PRIMARY KEY,
service_code   VARCHAR2(50),
service_name   VARCHAR2(200),
service_desc   VARCHAR2(1000),
service_cost   NUMBER,
status         NUMBER,
cre_by         VARCHAR2(100),
cre_dt         DATE,
upd_by         VARCHAR2(100),
upd_dt         DATE
);

CREATE SEQUENCE service_list_seq START WITH 1 INCREMENT BY 5 NOCACHE NOCYCLE;

CREATE OR REPLACE TRIGGER trg_service_list_bi
BEFORE INSERT OR UPDATE ON service_list
FOR EACH ROW
DECLARE v_seq NUMBER; v_code VARCHAR2(100);
BEGIN
IF INSERTING THEN
v_seq := service_list_seq.NEXTVAL;
IF :NEW.service_code IS NOT NULL THEN
v_code := UPPER(TRIM(:NEW.service_code));
:NEW.servicelist_id := v_code || TO_CHAR(v_seq);
ELSE
:NEW.servicelist_id := TO_CHAR(v_seq);
END IF;
IF :NEW.status IS NULL THEN :NEW.status := 1; END IF;
IF :NEW.cre_by IS NULL THEN :NEW.cre_by := NVL(V('APP_USER'), USER); END IF;
IF :NEW.cre_dt IS NULL THEN :NEW.cre_dt := SYSDATE; END IF;
ELSIF UPDATING THEN
IF :NEW.upd_by IS NULL THEN :NEW.upd_by := NVL(V('APP_USER'), USER); END IF;
IF :NEW.upd_dt IS NULL THEN :NEW.upd_dt := SYSDATE; END IF;
END IF;
END;
/



-- =========================
-- 5) expense_list
-- =========================
CREATE TABLE expense_list (
expense_type_id VARCHAR2(50) PRIMARY KEY,
expense_code    VARCHAR2(50),
type_name       VARCHAR2(200),
description     VARCHAR2(1000),
default_amount  NUMBER(15,2),
status          NUMBER,
cre_by          VARCHAR2(100),
cre_dt          DATE,
upd_by          VARCHAR2(100),
upd_dt          DATE
);

CREATE SEQUENCE expense_list_seq START WITH 1 INCREMENT BY 5 NOCACHE NOCYCLE;

CREATE OR REPLACE TRIGGER trg_expense_list_bi
BEFORE INSERT OR UPDATE ON expense_list
FOR EACH ROW
DECLARE v_seq NUMBER; v_code VARCHAR2(100);
BEGIN
IF INSERTING THEN
v_seq := expense_list_seq.NEXTVAL;
IF :NEW.expense_code IS NOT NULL THEN
v_code := UPPER(TRIM(:NEW.expense_code));
:NEW.expense_type_id := v_code || TO_CHAR(v_seq);
ELSE
:NEW.expense_type_id := TO_CHAR(v_seq);
END IF;
IF :NEW.status IS NULL THEN :NEW.status := 1; END IF;
IF :NEW.cre_by IS NULL THEN :NEW.cre_by := NVL(V('APP_USER'), USER); END IF;
IF :NEW.cre_dt IS NULL THEN :NEW.cre_dt := SYSDATE; END IF;
ELSIF UPDATING THEN
IF :NEW.upd_by IS NULL THEN :NEW.upd_by := NVL(V('APP_USER'), USER); END IF;
IF :NEW.upd_dt IS NULL THEN :NEW.upd_dt := SYSDATE; END IF;
END IF;
END;
/

-- =========================
-- 6) expense_master  (expense_by is VARCHAR2 now, no FK to employees)
-- =========================
CREATE TABLE expense_master (
expense_id      VARCHAR2(50) PRIMARY KEY,
expense_code    VARCHAR2(50),
expense_date    DATE,
expense_by      VARCHAR2(100),
expense_type_id VARCHAR2(50),
total_amount    NUMBER(15,2),
remarks         VARCHAR2(1000),
status          NUMBER,
cre_by          VARCHAR2(100),
cre_dt          DATE,
upd_by          VARCHAR2(100),
upd_dt          DATE,
CONSTRAINT fk_exp_master_type FOREIGN KEY (expense_type_id)
REFERENCES expense_list(expense_type_id)
);

CREATE SEQUENCE expense_master_seq START WITH 1 INCREMENT BY 5 NOCACHE NOCYCLE;

CREATE OR REPLACE TRIGGER trg_expense_master_bi
BEFORE INSERT OR UPDATE ON expense_master
FOR EACH ROW
DECLARE v_seq NUMBER; v_code VARCHAR2(100);
BEGIN
IF INSERTING THEN
v_seq := expense_master_seq.NEXTVAL;
IF :NEW.expense_code IS NOT NULL THEN
v_code := UPPER(TRIM(:NEW.expense_code));
:NEW.expense_id := v_code || TO_CHAR(v_seq);
ELSE
:NEW.expense_id := TO_CHAR(v_seq);
END IF;
IF :NEW.status IS NULL THEN :NEW.status := 1; END IF;
IF :NEW.cre_by IS NULL THEN :NEW.cre_by := NVL(V('APP_USER'), USER); END IF;
IF :NEW.cre_dt IS NULL THEN :NEW.cre_dt := SYSDATE; END IF;
ELSIF UPDATING THEN
IF :NEW.upd_by IS NULL THEN :NEW.upd_by := NVL(V('APP_USER'), USER); END IF;
IF :NEW.upd_dt IS NULL THEN :NEW.upd_dt := SYSDATE; END IF;
END IF;
END;
/


-- =========================
-- 7) expense_details
-- =========================
CREATE TABLE expense_details (
    expense_det_id    VARCHAR2(50) PRIMARY KEY,
    detail_code       VARCHAR2(50),
    expense_id        VARCHAR2(50) NOT NULL,
    expense_type_id   VARCHAR2(50) NOT NULL,
    description       VARCHAR2(1000),
    amount            NUMBER(15,2) DEFAULT 0,
    quantity          NUMBER DEFAULT 1,
    line_total        NUMBER(15,2),
    status            NUMBER,
    cre_by            VARCHAR2(100),
    cre_dt            DATE,
    upd_by            VARCHAR2(100),
    upd_dt            DATE,
    CONSTRAINT fk_exp_det_master FOREIGN KEY (expense_id) REFERENCES expense_master(expense_id),
    CONSTRAINT fk_exp_det_type   FOREIGN KEY (expense_type_id) REFERENCES expense_list(expense_type_id)
);
CREATE SEQUENCE expense_details_seq START WITH 1 INCREMENT BY 5 NOCACHE NOCYCLE;
CREATE OR REPLACE TRIGGER trg_expense_details
BEFORE INSERT OR UPDATE ON expense_details
FOR EACH ROW
DECLARE v_seq_val NUMBER; v_code VARCHAR2(100);
BEGIN
  IF INSERTING THEN
    v_seq_val := expense_details_seq.NEXTVAL;
    IF :NEW.detail_code IS NOT NULL THEN
      v_code := UPPER(TRIM(:NEW.detail_code));
      :NEW.expense_det_id := v_code || TO_CHAR(v_seq_val);
    ELSE
      :NEW.expense_det_id := TO_CHAR(v_seq_val);
    END IF;
    IF :NEW.line_total IS NULL THEN :NEW.line_total := NVL(:NEW.amount,0) * NVL(:NEW.quantity,1); END IF;
    IF :NEW.status IS NULL THEN :NEW.status := 1; END IF;
    IF :NEW.cre_by IS NULL THEN :NEW.cre_by := NVL(V('APP_USER'), USER); END IF;
    IF :NEW.cre_dt IS NULL THEN :NEW.cre_dt := SYSDATE; END IF;
  ELSIF UPDATING THEN
    IF UPDATING('amount') OR UPDATING('quantity') THEN
      :NEW.line_total := NVL(:NEW.amount,0) * NVL(:NEW.quantity,1);
    END IF;
    IF :NEW.upd_by IS NULL THEN :NEW.upd_by := NVL(V('APP_USER'), USER); END IF;
    IF :NEW.upd_dt IS NULL THEN :NEW.upd_dt := SYSDATE; END IF;
  END IF;
END;
/
CREATE INDEX idx_exp_det_exp ON expense_details(expense_id);
CREATE INDEX idx_exp_det_type ON expense_details(expense_type_id);


CREATE TABLE product_categories (
    product_cat_id    VARCHAR2(50) PRIMARY KEY,
    product_cat_name  VARCHAR2(30),
    status            VARCHAR2(50),
    cre_by            VARCHAR2(30),
    cre_dt            DATE,
    upd_by            VARCHAR2(30),
    upd_dt            DATE
);

CREATE SEQUENCE product_categories_seq START WITH 1 INCREMENT BY 5 NOCACHE NOCYCLE;

CREATE OR REPLACE TRIGGER trg_product_categories_bi
BEFORE INSERT OR UPDATE ON product_categories
FOR EACH ROW
DECLARE v_seq NUMBER; v_code VARCHAR2(100);
BEGIN
 IF INSERTING THEN
  v_seq := product_categories_seq.NEXTVAL;
  IF :NEW.product_cat_name IS NOT NULL THEN
    v_code := UPPER(SUBSTR(TRIM(:NEW.product_cat_name),1,3));
    :NEW.product_cat_id := v_code || TO_CHAR(v_seq);
  ELSE
    :NEW.product_cat_id := TO_CHAR(v_seq);
  END IF;
  IF :NEW.status IS NULL THEN :NEW.status := 1; END IF;
  IF :NEW.cre_by IS NULL THEN :NEW.cre_by := NVL(V('APP_USER'), USER); END IF;
  IF :NEW.cre_dt IS NULL THEN :NEW.cre_dt := SYSDATE; END IF;
 ELSE
  IF :NEW.upd_by IS NULL THEN :NEW.upd_by := NVL(V('APP_USER'), USER); END IF;
  IF :NEW.upd_dt IS NULL THEN :NEW.upd_dt := SYSDATE; END IF;
 END IF;
END;
/

CREATE TABLE sub_categories (
    sub_cat_id       VARCHAR2(50) PRIMARY KEY,
    sub_cat_name     VARCHAR2(30),
    product_cat_id   VARCHAR2(50),
    status           VARCHAR2(50),
    cre_by           VARCHAR2(30),
    cre_dt           DATE,
    upd_by           VARCHAR2(30),
    upd_dt           DATE,
    CONSTRAINT fk_subcat_productcat FOREIGN KEY (product_cat_id) REFERENCES product_categories(product_cat_id)
);

CREATE SEQUENCE sub_categories_seq START WITH 1 INCREMENT BY 5 NOCACHE NOCYCLE;

CREATE OR REPLACE TRIGGER trg_sub_categories_bi
BEFORE INSERT OR UPDATE ON sub_categories
FOR EACH ROW
DECLARE v_seq NUMBER; v_code VARCHAR2(100);
BEGIN
 IF INSERTING THEN
  v_seq := sub_categories_seq.NEXTVAL;
  IF :NEW.sub_cat_name IS NOT NULL THEN
    v_code := UPPER(SUBSTR(TRIM(:NEW.sub_cat_name),1,3));
    :NEW.sub_cat_id := v_code || TO_CHAR(v_seq);
  ELSE
    :NEW.sub_cat_id := TO_CHAR(v_seq);
  END IF;
  IF :NEW.status IS NULL THEN :NEW.status := 1; END IF;
  IF :NEW.cre_by IS NULL THEN :NEW.cre_by := NVL(V('APP_USER'), USER); END IF;
  IF :NEW.cre_dt IS NULL THEN :NEW.cre_dt := SYSDATE; END IF;
 ELSE
  IF :NEW.upd_by IS NULL THEN :NEW.upd_by := NVL(V('APP_USER'), USER); END IF;
  IF :NEW.upd_dt IS NULL THEN :NEW.upd_dt := SYSDATE; END IF;
 END IF;
END;
/


CREATE TABLE brand (
    brand_id      VARCHAR2(50) PRIMARY KEY,
    brand_name    VARCHAR2(30),
    model_name    VARCHAR2(20),
    product_size  VARCHAR2(15),
    color         VARCHAR2(10),
    status        VARCHAR2(50),
    cre_by        VARCHAR2(10),
    cre_dt        DATE,
    upd_by        VARCHAR2(10),
    upd_dt        DATE
);

CREATE SEQUENCE brand_seq START WITH 1 INCREMENT BY 5 NOCACHE NOCYCLE;

CREATE OR REPLACE TRIGGER trg_brand_bi
BEFORE INSERT OR UPDATE ON brand
FOR EACH ROW
DECLARE v_seq NUMBER; v_code VARCHAR2(100);
BEGIN
 IF INSERTING THEN
  v_seq := brand_seq.NEXTVAL;
  IF :NEW.brand_name IS NOT NULL THEN
    v_code := UPPER(SUBSTR(TRIM(:NEW.brand_name),1,3));
    :NEW.brand_id := v_code || TO_CHAR(v_seq);
  ELSE
    :NEW.brand_id := TO_CHAR(v_seq);
  END IF;
  IF :NEW.status IS NULL THEN :NEW.status := 1; END IF;
  IF :NEW.cre_by IS NULL THEN :NEW.cre_by := NVL(V('APP_USER'), USER); END IF;
  IF :NEW.cre_dt IS NULL THEN :NEW.cre_dt := SYSDATE; END IF;
 ELSE
  IF :NEW.upd_by IS NULL THEN :NEW.upd_by := NVL(V('APP_USER'), USER); END IF;
  IF :NEW.upd_dt IS NULL THEN :NEW.upd_dt := SYSDATE; END IF;
 END IF;
END;
/


CREATE TABLE suppliers (
    supplier_id VARCHAR2(50) PRIMARY KEY,
    supplier_name VARCHAR2(30) NOT NULL,
    phone_no VARCHAR2(50),
    email VARCHAR2(30),
    address VARCHAR2(30),
    contact_person VARCHAR2(30),
    cp_designation  VARCHAR2(100),
    cp_phone_no VARCHAR2(50),
    cp_email VARCHAR2(30),
    purchase_total NUMBER DEFAULT 0,
    pay_total NUMBER DEFAULT 0,
    due NUMBER GENERATED ALWAYS AS (NVL(purchase_total,0) - NVL(pay_total,0)) VIRTUAL,
    status NUMBER,
    cre_by VARCHAR2(20),
    cre_dt DATE,
    upd_by VARCHAR2(20),
    upd_dt DATE
);
CREATE SEQUENCE suppliers_seq START WITH 1 INCREMENT BY 5 NOCACHE NOCYCLE;

CREATE OR REPLACE TRIGGER trg_suppliers_bi
BEFORE INSERT OR UPDATE ON suppliers
FOR EACH ROW
DECLARE v_seq NUMBER; v_code VARCHAR2(100);
BEGIN
 IF INSERTING THEN
  v_seq := suppliers_seq.NEXTVAL;
  IF :NEW.supplier_name IS NOT NULL THEN
    v_code := UPPER(SUBSTR(TRIM(:NEW.supplier_name),1,3));
    :NEW.supplier_id := v_code || TO_CHAR(v_seq);
  ELSE
    :NEW.supplier_id := TO_CHAR(v_seq);
  END IF;
  IF :NEW.status IS NULL THEN :NEW.status := 1; END IF;
  IF :NEW.cre_by IS NULL THEN :NEW.cre_by := NVL(V('APP_USER'), USER); END IF;
  IF :NEW.cre_dt IS NULL THEN :NEW.cre_dt := SYSDATE; END IF;
 ELSE
  IF :NEW.upd_by IS NULL THEN :NEW.upd_by := NVL(V('APP_USER'), USER); END IF;
  IF :NEW.upd_dt IS NULL THEN :NEW.upd_dt := SYSDATE; END IF;
 END IF;
END;
/

CREATE TABLE products (
    product_id        varchar2(50) PRIMARY KEY,
    product_code      VARCHAR2(30) UNIQUE,
    product_name      VARCHAR2(100) NOT NULL,
    subcategory_id    VARCHAR2(50),
    category_id      VARCHAR2(50),
    supplier_id      VARCHAR2(50),
    brand_id         VARCHAR2(50),
    uom               VARCHAR2(50),
    mrp               NUMBER,
    purchase_price    NUMBER,
    warranty_24_12    VARCHAR2(20),
    status            VARCHAR2(50),
    status_num        NUMBER,
    cre_by            VARCHAR2(20),
    cre_dt            DATE,
    upd_by            VARCHAR2(20),
    upd_dt            DATE,
    CONSTRAINT fk_products_supplier FOREIGN KEY (supplier_id) REFERENCES suppliers(supplier_id),
    CONSTRAINT fk_products_category FOREIGN KEY (category_id) REFERENCES product_categories(product_cat_id),
    CONSTRAINT fk_products_subcategory FOREIGN KEY (subcategory_id) REFERENCES sub_categories(sub_cat_id),
    CONSTRAINT fk_products_brand FOREIGN KEY (brand_id) REFERENCES brand(brand_id)
);

CREATE SEQUENCE products_seq START WITH 1 INCREMENT BY 5 NOCACHE NOCYCLE;

CREATE OR REPLACE TRIGGER trg_products_bi
BEFORE INSERT OR UPDATE ON products
FOR EACH ROW
DECLARE v_seq NUMBER; v_code VARCHAR2(100);
BEGIN
 IF INSERTING THEN
  v_seq := products_seq.NEXTVAL;
  IF :NEW.product_code IS NOT NULL THEN
    v_code := UPPER(TRIM(:NEW.product_code));
    :NEW.product_id := v_code || TO_CHAR(v_seq);
  ELSE
    :NEW.product_id := TO_CHAR(v_seq);
  END IF;
  IF :NEW.status_num IS NULL THEN :NEW.status_num := 1; END IF;
  IF :NEW.cre_by IS NULL THEN :NEW.cre_by := NVL(V('APP_USER'), USER); END IF;
  IF :NEW.cre_dt IS NULL THEN :NEW.cre_dt := SYSDATE; END IF;
 ELSE
  IF :NEW.upd_by IS NULL THEN :NEW.upd_by := NVL(V('APP_USER'), USER); END IF;
  IF :NEW.upd_dt IS NULL THEN :NEW.upd_dt := SYSDATE; END IF;
 END IF;
END;
/

--------------------------------------------------
COMMIT;
